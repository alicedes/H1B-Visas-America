USE hlb;

#1. Find the jobs that the student prefer the most, in which have "Data" in them
SELECT DISTINCT soc_title AS jobs, COUNT(visa_id) AS cases
FROM soc_code
LEFT JOIN visa USING (soc_id)
WHERE soc_title LIKE "%data%"
GROUP BY soc_title
ORDER BY cases DESC;

#2. Find the top industry that has the top 5 jobs founded 
SELECT DISTINCT soc_title AS jobs, industry, COUNT(visa_id) AS total_cases
FROM visa
LEFT JOIN soc_code USING (soc_id)
LEFT JOIN naics USING (naics_id)
WHERE soc_title LIKE "%data%"
GROUP BY soc_title, industry
ORDER BY total_cases DESC;

#3. Find the top state locations for "Data" Jobs, and how many previous cases are there
SELECT DISTINCT state, COUNT(visa_id) AS total_cases
FROM visa
LEFT JOIN soc_code USING (soc_id)
LEFT JOIN naics USING (naics_id)
LEFT JOIN worksite USING (worksite_id)
WHERE soc_title LIKE "%data%"
AND (industry = 'Custom Computer Programming Services' OR industry = 'Internet Publishing and Broadcasting and Web Search Portals' OR industry = 'Computing Infrastructure Providers, Data Processing, Web Hosting, and Related Services')
GROUP BY state
ORDER BY total_cases DESC
LIMIT 3;

#4. Understanding if there is a posibilities for the student to continue their H1-B visa with their preffered job
SELECT DISTINCT soc_title AS jobs, continued_employment AS ce, COUNT(visa_id) AS total_cases
FROM visa
LEFT JOIN soc_code USING (soc_id)
LEFT JOIN worksite USING (worksite_id)
WHERE soc_title LIKE "%data%"
AND continued_employment > 1
GROUP BY soc_title, ce
ORDER BY total_cases DESC;

#5. The overview of the average duration for the visa application process for the student, based on the previous queries
SELECT ROUND(AVG(decision_date - received_date),2) AS process_duration , COUNT(visa_id) AS total_cases
FROM visa
LEFT JOIN soc_code USING (soc_id)
LEFT JOIN naics USING (naics_id)
LEFT JOIN worksite USING (worksite_id)
WHERE soc_title LIKE "%data%"
AND (industry = 'Custom Computer Programming Services' OR industry = 'Internet Publishing and Broadcasting and Web Search Portals' OR industry = 'Computing Infrastructure Providers, Data Processing, Web Hosting, and Related Services')
AND (state = 'IL' OR state = 'TX' OR state = 'CA')
ORDER BY total_cases DESC;